<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Kyvex API</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <%- include('../partials/header', { username: username }) %>
    <div class="container">
        <%- include('../partials/sidebar', { currentPage: currentPage }) %>
        <main class="main-content">
    <div class="page-header">
        <h1>API Keys</h1>
        <p>Manage API keys for external applications</p>
    </div>

    <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-success"><%= message %></div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-error"><%= error %></div>
    <% } %>

    <div class="card">
        <h2>Create New API Key</h2>
        <form action="/admin/api-keys" method="POST" style="margin-top: 1rem;">
            <div class="form-group">
                <label for="name">Name (optional)</label>
                <input type="text" id="name" name="name" placeholder="e.g., Mobile App Production">
            </div>
            <div class="form-group">
                <label for="rateLimit">Rate Limit (optional)</label>
                <input type="number" id="rateLimit" name="rateLimit" placeholder="Requests per 15 minutes" min="1">
            </div>
            <button type="submit" class="btn btn-primary">Create API Key</button>
        </form>
    </div>

    <div class="card">
        <h2>Existing API Keys</h2>
        <% if (typeof apiKeys !== 'undefined' && apiKeys.length > 0) { %>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>API Key</th>
                        <th>Usage Count</th>
                        <th>Rate Limit</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Last Used</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% apiKeys.forEach(key => { %>
                        <tr>
                            <td><%= key.name || 'Unnamed' %></td>
                            <td><code><%= key.apiKey.substring(0, 20) %>...</code></td>
                            <td><%= key.usageCount || 0 %></td>
                            <td><%= key.rateLimit || 'Unlimited' %></td>
                            <td>
                                <span style="color: <%= key.isActive ? '#27ae60' : '#e74c3c' %>">
                                    <%= key.isActive ? 'Active' : 'Inactive' %>
                                </span>
                            </td>
                            <td><%= new Date(key.createdAt).toLocaleDateString() %></td>
                            <td><%= key.lastUsedAt ? new Date(key.lastUsedAt).toLocaleDateString() : 'Never' %></td>
                            <td>
                                <button onclick="toggleKeyStatus('<%= key._id %>', <%= key.isActive %>)" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    <%= key.isActive ? 'Deactivate' : 'Activate' %>
                                </button>
                                <button onclick="deleteKey('<%= key._id %>')" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem; margin-left: 0.5rem;">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <p>No API keys found. Create one above.</p>
        <% } %>
    </div>

    <script>
        async function toggleKeyStatus(id, currentStatus) {
            if (!confirm('Are you sure you want to ' + (currentStatus ? 'deactivate' : 'activate') + ' this API key?')) {
                return;
            }

            try {
                const response = await fetch('/admin/api-keys/' + id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        isActive: !currentStatus,
                    }),
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to update API key');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update API key');
            }
        }

        async function deleteKey(id) {
            if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/admin/api-keys/' + id, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete API key');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to delete API key');
            }
        }
    </script>
        </main>
    </div>
    <script src="/js/admin.js"></script>
</body>
</html>
